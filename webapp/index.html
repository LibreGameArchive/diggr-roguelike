<!DOCTYPE html>
<html>
<head>
  <link type="text/css" href="http://code.jquery.com/ui/1.8.16/themes/ui-lightness/jquery-ui.css" rel="Stylesheet" />
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="http://code.jquery.com/ui/1.8.16/jquery-ui.min.js"></script>
  <style>
     .ui-widget { font-size: 11px; }
     .score { list-style-type: none; 
              margin: 10px; 
              cursor: pointer; }
     .entryscore { font-size: 15px;
                   color: #0F0FF0; 
                   margin-left: 10px; }
     .entrydate { font-size: 11px;
                  color: #0F0F0F; }
  </style>
</head>

<body>

  <form>
    <div id="sortby">
	  <input type="radio" id="sortbytime" name="sortby"/>
      <label for="sortbytime">Sort by time</label>
	  <input type="radio" id="sortbyscore" name="sortby"/>
      <label for="sortbyscore">Sort by score</label>
    </div>
  </form>

  <ul>
  <div id="entries"/>
  </ul>

  <ul id="filters" style="list-style-type:none">
  <li><button id="filteradd">Add filter</button></li>
  </ul>

  <button id="reload">Refresh</button>

<script>

function format(item) {
   var date = new Date(item["time"] * 1000);
   return '&#x276D; <span class="entryscore">' + item["score"] + " points. " +
          '<span class="entrydate">(' + date.toGMTString() + ")</span>";
}

function showgame(id) {
  $.getJSON("scripts/global-highscore.py",
            { "gameid" : id },
      function(data) {
        var date = new Date(data["time"] * 1000);

        var text = "Time: " + date.toGMTString() + "<br/>" +
                   "Score: " + data["score"] + "<br/>" + 
                   "Placed #" + data["place"] + " out of " + data["numgames"] + "<br/>" +
                   "<br/>Achievements:<br/><br/>" +
                   '<table border="0">';

        var lis = [];
        $.each(data["achievements"], function(i,item) {
           lis.push("<tr><td>" + item["text"] + "</td><td>#" + item["place"] + " of " + item["numgames"] + "</td></tr>");
        });

        text += lis.join("");
        text += "</table>";
        $("<div/>").attr("title", "Game ID: " + id).html(text).dialog();
     })
}

function reload() {
  //var qs = document.location.search.split("?")[1];

  var params = {};

  if (window.sortbytime) {
    params["sort"] = 1;
  } else if (window.sortbyscore) {
    params["sort"] = 2;
  }

  $("#entries").html("");

  params["ach"] = $.map($("select"), function(i) { return i.value; });

  $.getJSON("scripts/global-highscore.py",
    params,
    function(data) {
      $.each(data, function(i,item){
        $("<li/>").attr("id", "i" + i).attr("class", "score").
                   html(format(item)).click(
            function() { showgame(item["id"]); }).appendTo("#entries");
      });
  });
}

window.filtersnum = 0;

function get_achievements() {
  $.getJSON("scripts/global-highscore.py",
            { "get_achievements" : 1 },
      function(data) {
        var selc = $("<select/>").attr("id", "filterselect").change(reload);
        $.each(data, function(i,item) {
           $("<option/>").attr("value", item["achievement"]).html(item["text"]).appendTo(selc);
        });

        var liid = "fli"+window.filtersnum;

        $("<li/>").attr("id", liid).html(selc).appendTo("#filters");
        $("<span>[&#x2718;]</span>").click(function() {
           $("#"+liid).remove();
           reload();
        }).appendTo("#"+liid);

        window.filtersnum++;
      }
  );
}


$("#sortbytime").click(function() {
  window.sortbytime = true;
  window.sortbyscore = false;
  reload();
});

$("#sortbyscore").click(function() {
  window.sortbytime = false;
  window.sortbyscore = true;
  reload();
});

$("#filteradd").click(get_achievements);

$("#reload").click(reload);

reload();

$(function() {
  $("#sortby").buttonset();
  $("#reload").button();
  $("#filteradd").button();
})

</script>

</body>
</html>
